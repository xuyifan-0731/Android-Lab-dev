# Android United: å¼€å‘å’Œè¯„ä¼°Androidæ™ºèƒ½ä½“çš„å¯å¤ç°ç¯å¢ƒ

è‹±æ–‡ç‰ˆçš„READMEå¯ä»¥åœ¨[è¿™é‡Œ](README.md)æ‰¾åˆ°ã€‚

<p align="center">
    <a href="https://arxiv.org/abs/" target="_blank">ğŸ“ƒ è®ºæ–‡ </a> 
</p>

è¿™ä¸ªä»“åº“æ˜¯Android Evaléƒ¨åˆ†çš„ä»£ç æ¡†æ¶ã€‚æˆ‘ä»¬æä¾›äº†ä¸¤ç§æ‰§è¡Œæ¨¡å¼ï¼šMacä¸Šçš„AVDï¼ˆarm64ï¼‰å’ŒLinuxä¸Šçš„Dockerï¼ˆx86_64ï¼‰ã€‚æ‚¨å¯ä»¥æ ¹æ®æˆ‘ä»¬çš„æ¡†æ¶è‡ªç”±æ·»åŠ æˆ–ä¿®æ”¹æ–°çš„ä»»åŠ¡æˆ–Androidé•œåƒã€‚æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„è¯„ä¼°æ¡†æ¶ï¼Œå¯ä»¥ç”¨äºè¯„ä¼°å„ç§Androidæ™ºèƒ½ä½“çš„æ€§èƒ½ã€‚æˆ‘ä»¬ä¹Ÿåœ¨æ¨è¿›æ›´å¼ºå¤§çš„å¼€æºAndroidæ™ºèƒ½ä½“çš„è®¾è®¡ï¼Œå¹¶å°†åœ¨æ•°æ®å’Œè®­ç»ƒæ–¹æ³•æœ€ç»ˆç¡®å®šåå‘å¸ƒå®Œæ•´çš„è®­ç»ƒæ•°æ®å’Œç›¸åº”çš„è®­ç»ƒä»£ç ã€‚

![](./assets/main-picture.png)

# Benchmarkç»„æˆ

åœ¨æˆ‘ä»¬çš„å®éªŒä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ç³»åˆ—åº”ç”¨ç¨‹åºè¿›è¡Œäº†å„ç§æµ‹è¯•ã€‚é€‰æ‹©çš„ç§»åŠ¨åº”ç”¨ç¨‹åºå¦‚ä¸‹ï¼š

- **Bluecoins**: ä¸€ä¸ªç”¨äºç®¡ç†ä¸ªäººè´¢åŠ¡ã€è·Ÿè¸ªæ”¯å‡ºå’Œæ”¶å…¥çš„åº”ç”¨ç¨‹åºã€‚
- **Calendar**: ä¸€ä¸ªå¸®åŠ©ç»„ç»‡æ—¥ç¨‹å®‰æ’å’Œè®¾ç½®æé†’çš„æ—¥å†åº”ç”¨ã€‚
- **Cantook**: ä¸€ä¸ªç”¨äºå­˜å‚¨ã€ç®¡ç†å’Œé˜…è¯»ç”µå­ä¹¦çš„ç”µå­ä¹¦é˜…è¯»å™¨ã€‚
- **Clock**: ä¸€ä¸ªæ˜¾ç¤ºæ—¶é—´ã€è®¾ç½®é—¹é’Ÿå’Œä½¿ç”¨ç§’è¡¨çš„æ—¶é’Ÿåº”ç”¨ã€‚
- **Contacts**: ä¸€ä¸ªç”¨äºå­˜å‚¨å’Œç»„ç»‡è”ç³»äººä¿¡æ¯çš„è”ç³»äººç®¡ç†åº”ç”¨ã€‚
- **Maps.me**: ä¸€ä¸ªç”¨äºå¯¼èˆªå’Œæ¢ç´¢ä½ç½®çš„ç¦»çº¿åœ°å›¾åº”ç”¨ã€‚
- **PiMusic**: ä¸€ä¸ªç”¨äºç»„ç»‡å’Œæ’­æ”¾æœ¬åœ°å­˜å‚¨éŸ³ä¹æ–‡ä»¶çš„éŸ³ä¹æ’­æ”¾å™¨åº”ç”¨ã€‚
- **Settings**: ä¸€ä¸ªç”¨äºé…ç½®è®¾å¤‡è®¾ç½®å’Œåå¥½çš„è®¾ç½®åº”ç”¨ã€‚
- **Zoom**: ä¸€ä¸ªç”¨äºä¸»æŒå’Œå‚åŠ åœ¨çº¿ä¼šè®®çš„è§†é¢‘ä¼šè®®åº”ç”¨ã€‚

è¿™äº›åº”ç”¨ç¨‹åºçš„é€‰æ‹©æ ‡å‡†æ˜¯æ¯ä¸ªåº”ç”¨ç¨‹åºå¿…é¡»ç‹¬ç«‹è¿è¡Œï¼Œæ— éœ€äº’è”ç½‘è¿æ¥æˆ–ç”¨æˆ·è´¦æˆ·ç™»å½•ã€‚è¿™ç¡®ä¿äº†è¯„ä¼°åœ¨ç›¸åŒæ¡ä»¶ä¸‹å¯ä»¥å§‹ç»ˆå¦‚ä¸€åœ°è¿›è¡Œï¼Œæ¶ˆé™¤äº†å¤–éƒ¨ä¾èµ–ï¼Œå¹¶é™ä½äº†éšç§æ³„éœ²çš„é£é™©ã€‚å› æ­¤ï¼Œè¿™ç§æ–¹æ³•ä¿æŒäº†æˆ‘ä»¬ç»“æœçš„å¯é æ€§å’Œå¯å¤ç°æ€§ã€‚

![](./assets/avd-subgoal-subcates.png)
# æ’è¡Œæ¦œ

XMLå’ŒSoMæ¨¡å¼çš„ä¸»è¦ç»“æœã€‚SRã€Sub-SRã€RRRå’ŒRORåˆ†åˆ«ä»£è¡¨æˆåŠŸç‡ã€å­ç›®æ ‡æˆåŠŸç‡ã€å†—ä½™ç‡å’Œåˆç†æ“ä½œç‡ã€‚å¯¹äºæ‰€æœ‰è¿™äº›æŒ‡æ ‡ï¼Œæ•°å€¼è¶Šé«˜è¡¨ç¤ºè¶Šå¥½ã€‚**-ft**è¡¨ç¤ºæŒ‡ä»¤å¾®è°ƒæ¨¡å‹ã€‚åœ¨æ¯ä¸ªæ¨¡å¼ä¸‹ï¼Œ**åŠ ç²—**è¡¨ç¤ºæœ€ä½³ç»“æœï¼Œ**ä¸‹åˆ’çº¿**è¡¨ç¤ºæ¬¡ä½³ç»“æœã€‚

![](./assets/leaderboard.png)


# å¿«é€Ÿå¼€å§‹

## è‡ªåŠ¨è¯„ä¼°

æˆ‘ä»¬æä¾›äº†ä¸¤ç§æµ‹è¯•æ–¹æ³•ï¼šMacä¸Šçš„AVDï¼ˆarm64ï¼‰å’ŒLinuxä¸Šçš„Dockerï¼ˆx86_64ï¼‰ã€‚

### ç¯å¢ƒé…ç½®

å…‹éš†æ­¤ä»“åº“å¹¶å®‰è£…ä¾èµ–é¡¹ã€‚

```bash
cd /path/to/your/repo
conda create -n Android-United python=3.11
conda activate Android-United
pip install -r requirements.txt
```

å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯Macä¸Šçš„AVDï¼ˆarm64ï¼‰ï¼Œè¯·å‚è€ƒ[è¿™é‡Œ](docs/prepare_for_mac.md)æ¥è®¾ç½®ç¯å¢ƒã€‚

å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯Linuxä¸Šçš„Dockerï¼ˆx86_64ï¼‰ï¼Œè¯·å‚è€ƒ[è¿™é‡Œ](docs/prepare_for_linux.md)æ¥è®¾ç½®ç¯å¢ƒã€‚

### è¿è¡Œè‡ªåŠ¨è¯„ä¼°Pipeline

è¿è¡Œï¼š

```bash
python eval.py -n test_name -c your path to config.yaml
```

æ¯ä¸ªé—®é¢˜çš„å…·ä½“è¾“å‡ºä¿å­˜åœ¨`./logs/evaluation/test_name`ä¸‹ï¼Œè¯„ä¼°ç»“æœä¿å­˜åœ¨`output`æ–‡ä»¶å¤¹ä¸­ã€‚

å¦‚æœæ‚¨åªæƒ³è¿è¡Œå‡ ä¸ªé—®é¢˜è¿›è¡Œæµ‹è¯•ï¼Œå¯ä»¥å‚è€ƒï¼š

```bash
python eval.py -n test_name -c your path to config.yaml --task_id taskid_1,taskid_2,taskid_3
```

æˆ‘ä»¬æ”¯æŒå¹¶è¡Œæµ‹è¯•ã€‚è¯·æ³¨æ„ï¼Œæ‚¨éœ€è¦æå‰ç¡®è®¤æœ‰è¶³å¤Ÿçš„å†…å­˜å’Œå­˜å‚¨ç©ºé—´ã€‚æ¯ä¸ªå¹¶å‘æµ‹è¯•å¤§çº¦å ç”¨6Gå†…å­˜å’Œ9Gå­˜å‚¨ç©ºé—´ã€‚

```bash
python eval.py -n test_name -c your path to config.yaml -p 3
```

æ¯ä¸ªé—®é¢˜çš„task_idå¯ä»¥åœ¨`evaluation/config`ä¸­æ‰¾åˆ°ã€‚

ä½¿ç”¨ä»¥ä¸‹ä»£ç ç”Ÿæˆè¯„ä¼°ç»“æœï¼š

```bash
# gpt-4o-2024-05-13è¯„æµ‹:
export OPENAI_API_KEY='your-api-key-here'
python generate_result.py --input_folder ./logs/evaluation/ --output_folder ./logs/evaluation/ --output_excel ./logs/evaluation/test_name.xlsx --judge_model gpt-4o-2024-05-13

# glm4è¯„æµ‹:
python generate_result.py --input_folder ./logs/evaluation/ --output_folder ./logs/evaluation/ --output_excel ./logs/evaluation/test_name.xlsx --judge_model glm4 --api_key your api key
```

ä½ éœ€è¦æ ¹æ®éœ€æ±‚å¡«å†™ judge modelå’Œapi_keyæˆ– api_baseã€‚æˆ‘ä»¬ç°åœ¨æ”¯æŒgpt-4o-2024-05-13 å’Œ glm4ã€‚generate_result.pyå°†åœ¨--input_irä¸‹ç”Ÿæˆæ‰€æœ‰æµ‹è¯•ç»“æœçš„Excelæ–‡ä»¶ï¼ŒåŒ…å«æ¯ä¸ªé—®é¢˜çš„è¯¦ç»†ç»“æœã€‚

## å¦‚ä½•ä¿®æ”¹åŸºç¡€æ¨¡å‹

`Agent`ç±»å·²åœ¨`agent/`æ–‡ä»¶å¤¹ä¸­é¢„å®šä¹‰ï¼ŒåŒ…å«åŸºäºoneapiçš„OpenAIæ¥å£å’Œå½“å‰éƒ¨ç½²çš„GLMæ¥å£çš„å®ç°ã€‚å¦‚æœéœ€è¦æ·»åŠ åŸºç¡€æ¨¡å‹ï¼Œæ‚¨éœ€è¦ï¼š

1. åœ¨`agent/`ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„Pythonæ–‡ä»¶ï¼Œå¹¶å‚è€ƒ`agent/model/OpenAIAgent`ï¼Œé€šè¿‡ç»§æ‰¿`Agent`ç±»å®ç°æ‚¨çš„æ¨¡å‹è°ƒç”¨ã€‚`act`å‡½æ•°è¾“å…¥å·²ç»æŒ‰ç…§OpenAI messageæ ¼å¼ç»„ç»‡ï¼Œè¾“å‡ºä¸ºå­—ç¬¦ä¸²ã€‚å¦‚æœå¯¹åº”æ¨¡å‹çš„è¾“å…¥æ ¼å¼ä¸OpenAIä¸åŒï¼Œå¯ä»¥å‚è€ƒ`claude_model`ä¸­çš„`format_history`å‡½æ•°å’Œ`qwen_model`ä¸­çš„`prompt_to_message`è¿›è¡Œä¿®æ”¹ã€‚`format_history`å¯ä»¥ç»„ç»‡å†å²è®°å½•æ ¼å¼ï¼Œ`prompt_to_message`æ–¹æ³•å°†å½“å‰å›åˆçš„æç¤ºå’Œå›¾åƒè¾“å…¥ï¼ˆå¦‚æœæœ‰ï¼‰ä¿®æ”¹ä¸ºå½“å‰æ¨¡å‹çš„å•å›åˆæ ¼å¼ã€‚
2. åœ¨`agent/__init__.py`ä¸­å¯¼å…¥æ‚¨çš„æ–°ç±»ã€‚
3. å°†`eval.py`ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ä¸­çš„`agent`å†…å®¹æ›¿æ¢ä¸ºï¼š

```yaml
agent:
    name: Your Agent Module Name
    args:
        max_new_tokens: 512
```

ç¡®ä¿åç§°ä¸æ‚¨å®ç°çš„ç±»ååŒ¹é…ï¼Œ`args`ä¸‹çš„å†…å®¹å°†ä¼ é€’ç»™æ‚¨çš„ç±»çš„`init`å‡½æ•°ã€‚

## æ·»åŠ æ–°ä»»åŠ¡çš„æ­¥éª¤

åœ¨ç¼–å†™æ–°ä»»åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œç¼–å†™ä»£ç å¹¶é€šè¿‡å®é™…è¿è¡Œç»“æœç¡®å®šä»£ç æ˜¯å¦æ­£ç¡®åŒæ ·é‡è¦ã€‚å› æ­¤ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ç¡®ä¿æ¯ä¸ªæ–°ä»»åŠ¡æ²¡æœ‰é”™è¯¯ã€‚

1. ç¼–å†™æ‚¨çš„ä»»åŠ¡ã€‚ä»»åŠ¡åŒ…æ‹¬yamlæ–‡ä»¶ã€è¯„ä¼°æ–¹æ³•å’Œç›¸åº”çš„ç§»åŠ¨åº”ç”¨å®‰è£…ã€‚
    1. ä»»åŠ¡çš„yamlæ–‡ä»¶åº”å‚è€ƒ`evaluation/config`ä¸‹çš„å…¶ä»–ç°æœ‰æ–‡ä»¶ï¼Œå¿…é¡»åŒ…å«`task_id`ã€`task`ã€`metric_type`å’Œ`metric_func`ã€‚`adb_query`ä»…åœ¨éœ€è¦é€šè¿‡adbå‘½ä»¤æŸ¥è¯¢ç»“æœæ—¶ä½¿ç”¨ã€‚å°½ç®¡`category`ç›®å‰å°šæœªä½¿ç”¨ï¼Œä½†å¼ºçƒˆå»ºè®®æ·»åŠ ã€‚
    2. è¯„ä¼°æ–¹æ³•éœ€è¦ç»§æ‰¿`evaluation/task/SingleTask`ç±»ã€‚åœ¨æ¯æ¬¡è®°å½•æ“ä½œåï¼Œ`judge`å‡½æ•°å°†æ‰§è¡Œï¼Œå…¶è¿”å›å€¼ä¸ºä¸€ä¸ªå­—å…¸ï¼š`{"judge_page": bool, "1": bool, ..., "complete": bool}`ã€‚ä»£ç å°†è®°å½•`judge_page`ä¸º`True`çš„æœ€åä¸€é¡µçš„åˆ¤æ–­ç»“æœï¼Œä¸”åªæœ‰å½“æ‰€æœ‰åˆ¤æ–­ç‚¹éƒ½æ­£ç¡®æ—¶æ‰åº”å°†`complete`è®¾ç½®ä¸º`True`ã€‚å¦‚æœæ˜¯ä¸€ä¸ªæ¯”è¾ƒè¿”å›å€¼çš„ä»»åŠ¡ï¼Œ`check_answer`æ–¹æ³•å·²ç»å®ç°ã€‚åœ¨è°ƒç”¨æ­¤å‡½æ•°ä¹‹å‰ï¼Œä¿®æ”¹`final_ground_truth`ä¸ºæ ‡å‡†ç­”æ¡ˆã€‚
    3. å‚è€ƒå…¶ä»–ä»»åŠ¡ï¼Œå°†æ‰€æœ‰è¯„ä¼°æ–¹æ³•å¯¼å…¥`evaluation/app_name/__init__.py`ä¸­çš„`function_map`ç±»ã€‚
    4. ä¸ºç¡®ä¿æ¨¡å‹èƒ½å¤Ÿæ­£ç¡®æ‰§è¡Œå¯åŠ¨å‘½ä»¤ï¼Œè¯·åœ¨`templates/packages/apps_dict`ä¸­æ·»åŠ åº”ç”¨åç§°å’Œç›¸åº”çš„åŒ…åã€‚åŒ…åå¯ä»¥é€šè¿‡æ‰§è¡Œ`adb -s {device} shell dumpsys window | grep mCurrentFocus | awk -F '/' '{print $1}' | awk '{print $NF}'`è·å–ã€‚
2. ä½¿ç”¨è‡³å°‘æœ€å…ˆè¿›çš„æ™ºèƒ½ä½“æ‰§è¡Œæ‚¨çš„ä»»åŠ¡å¹¶ç”Ÿæˆè¯„ä¼°ç»“æœã€‚å¦‚æœ‰å¿…è¦ï¼Œåœ¨æ¨¡å‹æ“ä½œé—´éš”æœŸé—´å¿«é€Ÿå®Œæˆæ­£ç¡®çš„æ“ä½œï¼Œä»¥ç¡®ä¿è®°å½•çš„æ“ä½œèƒ½å¤Ÿæ•è·ä¸¤æ¬¡æ¨¡å‹æ“ä½œä¹‹é—´çš„æ­£ç¡®ç»“æœé¡µé¢ï¼Œä»è€Œæµ‹è¯•æ‚¨çš„ä»£ç æ˜¯å¦èƒ½å¤Ÿå®Œæˆæ£€æµ‹ä»»åŠ¡ã€‚
3. ä½¿ç”¨`tools/check_result_multiprocess.py`å‡½æ•°ç”Ÿæˆæ¯ä¸€æ­¥çš„æˆªå›¾ã€‚é‡ç‚¹æ£€æŸ¥æ­£ç¡®çš„æ¨¡å‹æ“ä½œæˆªå›¾æ˜¯å¦ç¡®å®è¢«åˆ¤æ–­ ä¸ºæ­£ç¡®ã€‚

## æ›´æ”¹AVDå¿«ç…§çš„æ­¥éª¤

å¦‚æœæ‚¨æƒ³å®šä¹‰ä¸€ä¸ªä¸android evalå¿«ç…§ä¸åŒçš„ç§»åŠ¨å¿«ç…§ï¼Œæ‚¨éœ€è¦éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. ä»é“¾æ¥ä¸‹è½½ç›¸å…³docker_no_avdæ–‡ä»¶ï¼šhttps://drive.google.com/file/d/1xpPEzVof5hrt5bQY6BHm_4Uoyq5mJQNb/view?usp=drive_link
2. è§£å‹æ–‡ä»¶ï¼Œè¿›å…¥è§£å‹åçš„æ–‡ä»¶å¤¹ï¼Œç„¶åè¿è¡Œï¼š

```bash
docker build -t android_eval_no_avd:latest .
```

3. åœ¨x86_64æœºå™¨ä¸Šé…ç½®æ‚¨çš„AVDå¿«ç…§ï¼ˆå»ºè®®ç›´æ¥ä½¿ç”¨Android Studioè¿›è¡Œé…ç½®ï¼‰ã€‚è¯·æ³¨æ„ï¼Œé»˜è®¤å®‰è£…çš„Android AVDç±»å‹ä¸ºï¼š

```dockerfile
RUN /bin/bash -c "source /root/.bashrc && yes | sdkmanager 'platform-tools' 'emulator' 'system-images;android-33;google_apis;x86_64'"
RUN /bin/bash -c "source /root/.bashrc && yes | sdkmanager 'build-tools;33.0.0'"
RUN /bin/bash -c "source /root/.bashrc && yes | sdkmanager 'platforms;android-33'"
```

å¦‚æœæ‚¨æƒ³é…ç½®ä¸åŒç‰ˆæœ¬çš„AVDï¼Œè¯·ä¿®æ”¹Dockerfileä¸­å®‰è£…çš„å…·ä½“ç‰ˆæœ¬å·ã€‚è¯·æ³¨æ„ï¼Œç‰ˆæœ¬å·å¿…é¡»ä¸¥æ ¼ä¸€è‡´ï¼Œå¦åˆ™å®‰è£…çš„é•œåƒå°†æ— æ³•è¯»å–ç°æœ‰ç¼“å­˜ã€‚

4. æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç ç”Ÿæˆdockerä¸­ä½¿ç”¨çš„AVDé•œåƒï¼š

```python
python tools/modify_mobile_to_docker.py 
    --avd_dir /Path/to/your/.android/avd 
    --device_name your device name 
    --save_dir /Path/to/your/save/avd
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼ä¿®æ”¹ï¼š

é€šè¿‡Android Studio -> è™šæ‹Ÿè®¾å¤‡ç®¡ç†å™¨ -> å³é”® -> åœ¨ç£ç›˜ä¸Šæ˜¾ç¤ºï¼Œæ‰¾åˆ°æ‚¨çš„.avdæ–‡ä»¶å¤¹å’Œ.iniæ–‡ä»¶ï¼Œå¹¶è¿›è¡Œä»¥ä¸‹ä¿®æ”¹ï¼š

åœ¨Pixel_7_Pro_API_33.iniä¸­ï¼Œå°†è·¯å¾„å’Œpath.relä¿®æ”¹ä¸ºä»¥ä¸‹è·¯å¾„ï¼š

```ini
avd.ini.encoding=UTF-8
path=/root/.android/avd/device name.avd
path.rel=avd/device name.avd
target=android-33
```

åœ¨Pixel_7_Pro_API_33.avd/config.iniä¸­ï¼Œä¿®æ”¹ä»¥ä¸‹è·¯å¾„ï¼š

```ini
...
image.sysdir.1 = system-images/android-33/google_apis/x86_64/
...
skin.path = /root/.android/skins/pixel_7_pro
...
```

ä¿æŒå…¶ä»–å†…å®¹ä¸å˜ã€‚

5. å¯åŠ¨ä¸€ä¸ªé•œåƒå¹¶å°†æ‚¨çš„.avdæ–‡ä»¶å¤¹å’Œ.iniæ–‡ä»¶å¤åˆ¶åˆ°é•œåƒä¸­ï¼š

```bash
docker run -it  android_eval_no_avd:latest /bin/bash 
docker cp /path/to/your/device name.avd container_id:/root/.android/avd
docker cp /path/to/your/device name.ini container_id:/root/.android/avd
```

å®Œæˆä¸Šè¿°æ“ä½œåï¼Œæ‚¨å¯ä»¥åœ¨é•œåƒä¸­æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

```bash
emulator -avd device name -no-window -no-audio -no-snapshot-save
```

éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸã€‚

